<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NZM IPTV ‚Äî Admin Panel (Fixed)</title>

  <!-- ‚úÖ Correct Firebase compat SDK (works in normal HTML) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    :root { --accent:#00ffff; --bg:#031417; --card:#072125; --muted:#9bdede; }
    body {
      margin:0; font-family:Segoe UI,Roboto,Arial;
      background:var(--bg); color:#e6fdfd; padding:24px;
    }
    h1 { color:var(--accent); margin-bottom:8px; }
    form {
      display:flex; flex-wrap:wrap; gap:10px;
      background:var(--card); padding:16px;
      border-radius:10px; border:1px solid rgba(0,255,255,0.15);
    }
    input,button {
      font-size:15px; border:none; border-radius:8px;
      padding:8px 10px;
    }
    input {
      background:#022d31; color:#cff;
      border:1px solid rgba(255,255,255,0.1);
    }
    button {
      background:var(--accent); color:#002;
      font-weight:600; cursor:pointer;
    }
    button:hover { opacity:0.9; }
    table { width:100%; margin-top:20px; border-collapse:collapse; font-size:14px; }
    th,td { padding:10px 8px; border-top:1px solid rgba(255,255,255,0.05); }
    th { color:var(--accent); text-align:left; }
    .status { padding:4px 8px; border-radius:8px; font-weight:600; }
    .active { background:rgba(0,255,170,0.15); color:#baffd8; }
    .expired { background:rgba(255,180,100,0.1); color:#ffdca8; }
    .off { background:rgba(255,80,80,0.1); color:#ffbdbd; }
    input[type="datetime-local"] {
      background:#022d31; color:#cff; border-radius:6px;
      border:1px solid rgba(255,255,255,0.1);
    }
  </style>
</head>
<body>
  <h1>NZM IPTV ‚Äî Admin Panel</h1>
  <p style="margin-bottom:16px;">Add and approve devices manually. Expiration is <b>required</b>.</p>

  <!-- üîπ Add Device Form -->
  <form id="addForm">
    <input id="nameInput" placeholder="User Name" required />
    <input id="idInput" placeholder="Device ID (e.g. DEV-XXXXXXX)" required />
    <input id="expInput" type="datetime-local" required />
    <button type="submit">Approve Device ID</button>
  </form>

  <!-- üîπ Devices Table -->
  <table id="deviceTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Device ID</th>
        <th>Expires At (Asia/Manila)</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="deviceList">
      <tr><td colspan="5" style="color:#9bdede;padding:16px;">Loading devices...</td></tr>
    </tbody>
  </table>

  <footer style="margin-top:16px;font-size:12px;color:#9bdede;">
    This panel writes directly to your Firebase Realtime Database.
  </footer>

<script>
  // ‚úÖ Firebase Configuration (your project)
  const firebaseConfig = {
    apiKey: "AIzaSyC2WerQR0ns5Nb884VC3hLLUjo9zmHum4I",
    authDomain: "device-id-fa609.firebaseapp.com",
    databaseURL: "https://device-id-fa609-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "device-id-fa609",
    storageBucket: "device-id-fa609.firebasestorage.app",
    messagingSenderId: "692838888581",
    appId: "1:692838888581:web:89100b9eb9b0e75fac65ec",
    measurementId: "G-20S0EJ950Z"
  };

  // ‚úÖ Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const devicesRef = db.ref("devices");

  const tbody = document.getElementById("deviceList");
  const form = document.getElementById("addForm");
  const nameInput = document.getElementById("nameInput");
  const idInput = document.getElementById("idInput");
  const expInput = document.getElementById("expInput");

  function formatLocal(iso) {
    if (!iso) return "‚Äî";
    try {
      return new Date(iso).toLocaleString("en-PH", { timeZone: "Asia/Manila" });
    } catch { return iso; }
  }

  function toLocalVal(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d)) return "";
    const pad = n => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function isExpired(iso) {
    if (!iso) return false;
    const t = Date.parse(iso);
    return !isNaN(t) && Date.now() > t;
  }

  // ‚úÖ Add Device
  form.onsubmit = async (e) => {
    e.preventDefault();
    const name = nameInput.value.trim();
    const id = idInput.value.trim().toUpperCase();
    const exp = expInput.value;
    if (!name || !id || !exp) return alert("All fields are required.");
    const iso = new Date(exp).toISOString();

    const deviceData = {
      name,
      approved: true,
      expiresAt: iso,
      createdAt: new Date().toISOString(),
      lastSeen: new Date().toISOString()
    };

    try {
      await devicesRef.child(id).set(deviceData);
      alert("‚úÖ Device approved successfully!");
      form.reset();
    } catch (err) {
      console.error("‚ùå Firebase write failed:", err);
      alert("Failed to approve device: " + err.message);
    }
  };

  // ‚úÖ Render Table
  devicesRef.on("value", (snap) => {
    const val = snap.val() || {};
    const keys = Object.keys(val);
    tbody.innerHTML = "";

    if (keys.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="color:#9bdede;padding:16px;">No devices yet.</td></tr>';
      return;
    }

    keys.forEach(id => {
      const d = val[id];
      const exp = d.expiresAt || "";
      const expired = isExpired(exp);
      const approved = !!d.approved;
      let status = "off", statusText = "Not Approved";

      if (approved && !expired) { status = "active"; statusText = "Active"; }
      else if (approved && expired) { status = "expired"; statusText = "Expired"; }

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${d.name || "‚Äî"}</td>
        <td><code>${id}</code></td>
        <td>
          <input type="datetime-local" id="exp-${id}" value="${toLocalVal(exp)}" />
          <button data-act="save" data-id="${id}">Save</button>
          <div style="font-size:12px;color:#9bdede">${formatLocal(exp)}</div>
        </td>
        <td><span class="status ${status}">${statusText}</span></td>
        <td>
          <button data-act="unapprove" data-id="${id}">Unapprove</button>
          <button data-act="delete" data-id="${id}" style="background:#ff8080;color:#111;">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });

    attachActions();
  });

  function attachActions() {
    document.querySelectorAll("button[data-act]").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id;
        const act = btn.dataset.act;

        if (act === "unapprove") {
          await devicesRef.child(id).update({ approved: false });
        } else if (act === "delete") {
          if (confirm("Delete device " + id + "?")) await devicesRef.child(id).remove();
        } else if (act === "save") {
          const input = document.getElementById(`exp-${id}`);
          const newExp = input.value;
          if (!newExp) return alert("Expiration required.");
          const iso = new Date(newExp).toISOString();
          await devicesRef.child(id).update({ expiresAt: iso, approved: true });
          alert("‚úÖ Expiration updated for " + id);
        }
      };
    });
  }

  // ‚úÖ Auto deactivate expired devices
  setInterval(async () => {
    const snap = await devicesRef.once("value");
    const val = snap.val() || {};
    const updates = {};
    Object.keys(val).forEach(id => {
      const d = val[id];
      if (d.expiresAt && isExpired(d.expiresAt) && d.approved === true) {
        updates[id + "/approved"] = false;
      }
    });
    if (Object.keys(updates).length > 0) {
      await devicesRef.update(updates);
      console.log("‚è∞ Auto-unapproved expired devices:", Object.keys(updates));
    }
  }, 60000);
</script>
</body>
  </html>

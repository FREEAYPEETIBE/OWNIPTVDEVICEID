<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NZM IPTV â€” Manual Admin Panel</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js"></script>

  <style>
    :root{--accent:#00ffff;--bg:#031417;--card:#072125;--muted:#9bdede;}
    body{margin:0;font-family:Segoe UI,Roboto,Arial;background:var(--bg);color:#e6fdfd;padding:24px;}
    h1{margin:0 0 8px 0;color:var(--accent);}
    form{display:flex;flex-wrap:wrap;gap:12px;background:var(--card);
      border:1px solid rgba(0,255,255,0.1);border-radius:10px;padding:16px;}
    input,button{font-size:15px;border:none;border-radius:8px;padding:8px 10px;}
    input{flex:1;min-width:160px;background:#022d31;color:#cff;border:1px solid rgba(255,255,255,0.1);}
    button{background:var(--accent);color:#002;font-weight:600;cursor:pointer;}
    button:hover{opacity:0.9;}
    table{width:100%;margin-top:20px;border-collapse:collapse;font-size:14px;}
    th,td{padding:10px 8px;border-top:1px solid rgba(255,255,255,0.05);}
    th{text-align:left;color:var(--accent);}
    .status{padding:4px 8px;border-radius:8px;font-weight:600;}
    .active{background:rgba(0,255,170,0.15);color:#baffd8;}
    .expired{background:rgba(255,180,100,0.1);color:#ffdca8;}
    .off{background:rgba(255,80,80,0.1);color:#ffbdbd;}
    .actions button{margin-right:6px;padding:5px 10px;}
    footer{margin-top:18px;font-size:12px;color:#9bdede;}
  </style>
</head>
<body>
  <h1>NZM IPTV â€” Admin Panel</h1>
  <p style="margin-bottom:16px;">Add / approve devices manually.  Expiration is <b>required</b>.</p>

  <!-- ðŸ”¹ Manual approval form -->
  <form id="addForm">
    <input id="nameInput" placeholder="User Name" required>
    <input id="idInput" placeholder="User Device ID (e.g. DEV-XXXXXXX)" required>
    <input id="expInput" type="datetime-local" required>
    <button type="submit">Approve Device ID</button>
  </form>

  <!-- ðŸ”¹ Devices table -->
  <table id="table">
    <thead>
      <tr><th>Name</th><th>Device ID</th><th>Expires At (UTC)</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="5" style="color:#9bdede;padding:16px;">No devices yet.</td></tr>
    </tbody>
  </table>

  <footer>
    <p>Open panel â€” anyone with the link can edit. Secure with Firebase Auth when ready.</p>
  </footer>

<script>
  // --- Firebase config (same as your project)
  const firebaseConfig = {
    apiKey:"AIzaSyC2WerQR0ns5Nb884VC3hLLUjo9zmHum4I",
    authDomain:"device-id-fa609.firebaseapp.com",
    databaseURL:"https://device-id-fa609-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:"device-id-fa609",
    storageBucket:"device-id-fa609.firebasestorage.app",
    messagingSenderId:"692838888581",
    appId:"1:692838888581:web:89100b9eb9b0e75fac65ec",
    measurementId:"G-20S0EJ950Z"
  };
  const app=firebase.initializeApp(firebaseConfig);
  const db=firebase.database();
  const devicesRef=db.ref("devices");

  const tbody=document.getElementById("tbody");
  const form=document.getElementById("addForm");
  const nameInput=document.getElementById("nameInput");
  const idInput=document.getElementById("idInput");
  const expInput=document.getElementById("expInput");

  // Format ISO -> readable
  function fmt(iso){if(!iso)return"â€”";try{return new Date(iso).toISOString().replace("T"," ").replace("Z"," UTC");}catch{return iso;}}
  function expired(iso){if(!iso)return false;const t=Date.parse(iso);return !isNaN(t)&&Date.now()>t;}

  // --- Add device manually
  form.onsubmit=async e=>{
    e.preventDefault();
    const name=nameInput.value.trim();
    const id=idInput.value.trim().toUpperCase();
    const expVal=expInput.value;
    if(!name||!id||!expVal){alert("All fields are required.");return;}
    const iso=new Date(expVal).toISOString();
    try{
      await devicesRef.child(id).set({
        name,approved:true,expiresAt:iso,
        createdAt:new Date().toISOString(),
        lastSeen:new Date().toISOString()
      });
      nameInput.value=idInput.value=expInput.value="";
      alert("âœ… Device approved!");
    }catch(err){alert("Failed: "+err.message);}
  };

  // --- Render devices
  devicesRef.on("value",snap=>{
    const val=snap.val()||{};
    const keys=Object.keys(val);
    tbody.innerHTML="";
    if(keys.length===0){
      tbody.innerHTML='<tr><td colspan="5" style="color:#9bdede;padding:16px;">No devices yet.</td></tr>';
      return;
    }
    keys.sort();
    keys.forEach(k=>{
      const d=val[k]; const exp=d.expiresAt||null;
      const isExp=expired(exp); const appr=!!d.approved;
      let cls="off",txt="Not Approved";
      if(appr&&!isExp){cls="active";txt="Active";}
      else if(appr&&isExp){cls="expired";txt="Expired";}
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${d.name||"â€”"}</td>
        <td><code>${k}</code></td>
        <td>${fmt(exp)}</td>
        <td><span class="status ${cls}">${txt}</span></td>
        <td class="actions">
          <button data-act="renew" data-id="${k}">Renew</button>
          <button data-act="unapprove" data-id="${k}">Unapprove</button>
          <button data-act="delete" data-id="${k}" style="background:#ff8080;color:#111;">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
    attachRowEvents();
  });

  function attachRowEvents(){
    document.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.onclick=async()=>{
        const id=btn.dataset.id, act=btn.dataset.act;
        if(act==="unapprove"){
          await devicesRef.child(id).update({approved:false});
        }else if(act==="renew"){
          const newExp=prompt("Enter new expiration (YYYY-MM-DD HH:MM local):");
          if(!newExp)return;
          const iso=new Date(newExp).toISOString();
          await devicesRef.child(id).update({expiresAt:iso,approved:true});
        }else if(act==="delete"){
          if(confirm("Delete device "+id+" ?"))await devicesRef.child(id).remove();
        }
      };
    });
  }

  // --- Auto-scan expired devices every minute
  setInterval(async()=>{
    const snap=await devicesRef.once("value");
    const val=snap.val()||{};
    const updates={};
    Object.keys(val).forEach(id=>{
      const d=val[id]; if(d.expiresAt&&expired(d.expiresAt)&&d.approved===true){
        updates[id+"/approved"]=false;
      }
    });
    if(Object.keys(updates).length>0)await devicesRef.update(updates);
  },60_000);
</script>
</body>
  </html>
